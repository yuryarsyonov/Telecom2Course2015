#SMTP-клиент
##Индивидуальное задание

Разработать приложение для операционных систем семейства Windows
или Linux, обеспечивающее функции клиента протокола SMTP.
Клиент должен быть написан на языке Python.

Приложение должно реализовывать следующие функции:

1. Создание нового письма, включающего такие поля, как
From (отправитель), To (получатель), Subject (тема),
Body (текст)
2. Формирование всех необходимых заголовков письма, с тем, чтобы
приёмная сторона не рассматривала данное письмо как спам.
3. Подключение к указанному SMTP-серверу и отсылка созданного
письма
4. Подробное протоколирование соединения клиента с сервером

Разработанное приложение должно реализовывать следующие команды протокола SMTP:

* HELO/EHLO – передача серверу информации о домене пользователя
* MAIL FROM – передача серверу адреса отправителя письма
* RCPT TO – передача серверу адреса получателя письма
* DATA – передача серверу тела письма
* QUIT – завершение сеанса связи

Настройки приложения. Разработанное приложение должно обеспечивать настройку следующих параметров:

1. Собственное доменное имя для передачи в команде HELO
2. Адрес отправителя
3. IP-адрес или доменное имя сервера SMTP

Методика тестирования. Для тестирования приложения следует использовать почтовые серверы, имеющиеся в лаборатории, а также бесплатные почтовые серверы, имеющиеся в сети Internet 
([http://www.mail.ru] (http://www.mail.ru), [http://www.yandex.ru] (http://www.yandex.ru), [http://www.rambler.ru] (http://www.rambler.ru),  и т.п.).
Средствами разработанного приложения осуществляется передача письма на указанные ящики электронной почты. Штатными клиентами электронной почты проверяется корректность доставки почты и правильность параметров письма.

##Теоритические сведения протокола SMTP 

###Обзор протокола

SMTP — требующий соединения текстовый протокол, по которому отправитель сообщения связывается с получателем посредством выдачи командных строк и получения необходимых данных через надёжный канал, в роли которого обычно выступает TCP-соединение (Transmission Control Protocol — протокол управления передачей). SMTP-сессия состоит из команд, посылаемых SMTP-клиентом, и соответствующих ответов SMTP-сервера. Когда сессия открыта, сервер и клиент обмениваются её параметрами. Сессия может включать ноль и более SMTP-операций (транзакций).
SMTP-операция состоит из трёх последовательностей команда/ответ (см. пример ниже). Описание последовательностей:

1.MAIL FROM — устанавливает обратный адрес (т. е. Return-Path, 5321.From, mfrom). Это адрес для возвращённых писем.
2.RCPT TO — устанавливает получателя данного сообщения. Эта команда может быть дана несколько раз, по одному на каждого получателя. Эти адреса также являются частью оболочки.
3.DATA — для отправки текста сообщения. Это само содержимое письма, в противоположность его оболочке. Он состоит из заголовка сообщения и тела сообщения, разделенных пустой строкой. DATA, по сути, является группой команд, а сервер отвечает дважды: первый раз на саму команду DATA, для уведомления о готовности принять текст; и второй раз после конца последовательности данных, чтобы принять или отклонить всё письмо.
Помимо промежуточных ответов для DATA-команды, каждый ответ сервера может быть положительным (код ответа 2хх) или отрицательным. Последний, в свою очередь, может быть постоянным (код 5хх) либо временным (код 4хх). Отказ SMTP-сервера в передаче сообщения — постоянная ошибка; в этом случае клиент должен отправить возвращённое письмо. После сброса — положительного ответа, сообщение скорее всего будет отвержено. Также сервер может сообщить о том, что ожидаются дополнительные данные от клиента (код 3xx).

Изначальным хостом (SMTP-клиентом) может быть как почтовый клиент конечного пользователя (функционально определяемый как почтовый агент — MUA), так и агент пересылки сообщений (MTA) на сервере, т.е. сервер действует как клиент в соответствующей сессии для ретрансляции сообщения. Полностью функциональные сервера поддерживают очереди сообщений для повторной передачи сообщения в случае ошибок.
MUA знает SMTP-сервер для исходящей почты из своих настроек. SMTP-сервер, действующий как клиент, т. е. пересылающий сообщения, определяет, к какому серверу подключиться, просмотром ресурса записей MX (Mail eXchange) DNS для домена каждого получателя. В случае, если запись MX не найдена, совместимые MTA (не все) возвращаются к простой А-записи. Пересылающие сервера также могут быть настроены на использование Smart host.
SMTP-сервер, действующий как клиент, устанавливает TCP-соединение с сервером по разработанному для SMTP порту 25. MUA должен использовать порт 587 для подключения к агенту предоставления сообщений (MSA). Основное различие между MTA и MSA заключается в том, что SMTP-аутентификация обязательна только для последнего.  

**SMTP и извлечение сообщений**

SMTP — всего лишь протокол доставки. Он не может по требованию взять сообщения с удаленного сервера. Для извлечения почты и управления почтовым ящиком разработаны другие протоколы, такие как POP и IMAP. Тем не менее, SMTP предоставляет возможность начать на удаленном сервере обработку очереди сообщений, при которой запрашивающая система может получать все направленные ей сообщения (см. Remote Message Queue Starting ниже). POP и IMAP предпочтительны, когда компьютер пользователя включен не постоянно, или же временно подключен к Интернету.

**Remote Message Queue Starting**  

Remote Message Queue Starting (запуск удаленной очереди сообщений) — особенность SMTP, позволяющая удаленному хосту начать обработку очереди сообщений на сервере так, что он может получать предназначенные ему сообщения с помощью команды TURN. Однако эта особенность считалась небезопасной и была расширена в RFC 1985 командой ETRN, которая работает надёжнее благодаря основанному на информации DNS методу аутентификации.

**Почтовые транзакции**  

ODMR (On-Demand Mail Relay — ретрансляция почты по требованию) — стандартизированное в RFC 2645 SMTP-расширение, позволяющее проводить ретрансляцию сообщения аутентифицированному пользователю.

**Интернационализация**

Многие пользователи, чей набор символов отличается от латиницы, сталкиваются с требованием адреса электронной почты на латинице. Для решения этой проблемы был создан RFC 6531, предоставляющий возможности для интернационализации для SMTP — расширение SMTPUTF8. RFC 6531 предоставляет поддержку многобайтных и не-ASCII символов в почтовом адресе, например: ??????@??????????.?????? или ??@??.??. Текущая поддержка ограничена, но есть большой интерес в широком распространении RFC 6531 и связанных с ним RFC в странах с обширной базой пользователей, для которых латиница не является родным алфавитом.

###Порядок команд

Сеанс, который будет включать почтовую транзакцию, должен быть сначала инициализирован командой EHLO. Серверам SMTP следует воспринимать без инициализации команды, не использующие почтовых транзакций.
Команда EHLO может вводиться клиентом в действующем сеансе. При первом использовании команды в данной сессии сервер SMTP должен очистить все буферы и сбросить состояние, как при получении команды RSET. 
Если команда EHLO неприемлема для сервера SMTP, он должен возвращать отклик 501, 500, 502 или 550. Сервер SMTP должен сохранять после передачи таких откликов состояние, которое было до получения команды EHLO.
Клиент SMTP должен (по возможности) предоставлять в параметрах команд EHLO первичное доменное имя (не CNAME или MX) своего хоста.  
Команда MAIL начинает почтовую транзакцию. После начала транзакции последняя включает начальную команду, одну или несколько команд RCPT и команду DATA, вводимые в указанном порядке. Почтовая транзакция прерывается командой RSET, новой командой EHLO или командой QUIT.
 В сеансе может происходить множество последовательных транзакций или не быть транзакций вообще. Недопустимо передавать команду MAIL, если почтовая транзакция уже открыта, т. е., эту команду можно передавать только при отсутствии в сеансе продолжающейся почтовой транзакции — предыдущая транзакция должна быть завершена успешным выполнением команды DATA или прервана командой RSET или новой командой EHLO.
Если аргумент начинающей транзакцию команды неприемлем, должен возвращаться отклик 501 и сервер SMTP должен сохранять свое состояние. Если в сеансе нарушается порядок команд в такой степени, что это препятствует их выполнению сервером, последний должен возвратить отклик 503, сохраняя свое состояние.
Последней командой сеанса должна быть команда QUIT. Клиентам следует использовать команду QUIT для разрыва соединения даже в тех случаях, когда команда организации сеанса не была передана и воспринята.

###SMTP-сервер исходящей почты

Почтовый клиент должен знать IP-адрес SMTP-сервера, который задается как часть конфигурации (обыкновенно в виде DNS-имени). Сервер будет доставлять исходящие сообщения от лица пользователя.

**Аутентификация клиента**

Вместо ограничения по местоположению, современные SMTP-сервера обычно требуют аутентификацию пользователей перед получением доступа. Эта система, будучи более гибкой, поддерживает мобильных пользователей и предоставляет им фиксированный выбор настроенного сервера исходящей почты.

**Порты**

Администраторы сервера выбирают, какой порт будут использовать клиенты для ретрансляции исходящей почты - 25 или 587. Спецификации и многие сервера поддерживают и тот, и другой порты. Хотя некоторые сервера поддерживают порт 465 для безопасного SMTP, но предпочтительнее использовать стандартные порты и ESMTP-команды, если необходима защищенная сессия между клиентом и сервером.
Некоторые сервера настроены на отклонение всех ретрансляций по порту 25, но пользователям, прошедшим аутентификацию по порту 587, позволено перенаправлять сообщения на любой действительный адрес.
Некоторые провайдеры перехватывают порт 25, перенаправляя трафик на свой собственный SMTP-сервер вне зависимости от адреса назначения. Таким образом, их пользователи не могут получить доступ к серверу за пределами провайдерской сети по порту 25.
Некоторые сервера поддерживают аутентифицированный доступ по дополнительному, отличному от 25, порту, позволяя пользователям соединяться с ними, даже если порт 25 заблокирован.

##Архитектура приложения
###Команды клиента и ответы сервера
 
<table>
  <tr>
    <th>Команда</th>
    <th>Описание</th>
    <th>Ответ сервера</th>
  </tr>
  <tr>
    <td> HELO [домен]</td>
    <td>Передает серверу домен отправителя</td>
    <td>250</td>
  </tr>
  <tr>
    <td>AUTH LOGIN</td>
    <td>Авторизация на сервере. Сервер проверяет, зарегистрирован ли пользователь</td>
    <td>334 – ответ на команду.   
        334 – ответ на логин.     
        235 – авторизация пройдена успешно.
    </td>
  </tr>
  <tr>
    <td> MAIL FROM [адрес]</td>
    <td>Передает серверу адрес отправителя</td>
    <td>250</td>
  </tr>
  <tr>
    <td> RCPT TO [адрес]</td>
    <td>Передает серверу адрес получателя</td>
    <td>250</td>
  </tr>
  <tr>
    <td> DATA [текс письма]  </td>
    <td>Передается письмо, со всеми заголовками и полями. Конец письма – точка в пустой строке</td>
    <td>354 – после отправки DATA.   250 – после отправки письма.  </td>
  </tr>
  <tr>
    <td> QUIT</td>
    <td>Разрыв соединения</td>
    <td>221</td>
</table>

Команда DATA имеет собственные заголовки, они добавляются для передачи полной информации о соообщении. 
У нас добавлены следующие заголовки: email_fro, email_to, subject, cc, data, bcc. Каждое поле заголовка содержит имя, после которого следует двоеточие, а затем следует значение этого поля.


###Дизайн приложения

При запуске приложения клиент видит на экране следующее сообщение:  
 
*Host: Требуется ввести адрес почтового сервера   * 
*Port: Требуется ввести номер порта*  

Затем нам необходимо указать свои логин и пароль:

*Login:
Password:*

Если Логин и Пароль верны, то устанавливается соединение между клиентом и сервером.
Затем необходимо указать адреса отправителя и получателя писем.

*Your e-mail:
Recipient e-mail:
Carbon copy e-mails:
BCC:*

Далее необходимо ввести тему и само сообщение:

*Subject:
Enter your message:*
  
После чего происходит попытка отправить сообщение с указанными параметрами и выводится сообщение об удачной или неудачной попытке отправки сообщения по указанным адресам.

При вводе команды quit анализируется соединение. Если соединение установлено, оно сбрасывается, и выводится сообщение об удачной операции quit.   

##Тестирование

Для тестирования приложения были написаны unit тесты.   
Задавая определенные параметры входных значений, проверим работу отдельных функций, таких как установление соединения, аутентификация клиента, отправка сообщения, разрыв соединения.   
Листинг unit тестов приведен в приложении.